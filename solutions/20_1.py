input_ = """Tile 3469:
.##..#.#.#
##..#...##
...#..##.#
....#.#..#
#..#.##...
.#.##.#.##
..#.#.....
..###.#..#
#.##.#...#
....#...##

Tile 3739:
..##..#..#
#.#...#..#
.....#.##.
.#..#....#
#.....#...
#..##.#..#
####.#.##.
##..#.#..#
..#......#
#..#.##.##

Tile 3581:
####.#..##
..#......#
.##...#...
#....#.###
..#..#.#..
#...#.....
#..####...
......#...
..#...#.##
##.#..#..#

Tile 2521:
..#.##..##
..#.#..##.
#.........
#.#.......
.#........
#.....#..#
..........
.#........
#........#
#.....#.#.

Tile 2729:
...##...##
....#..#..
#...##....
##.#......
#..#..#.##
.#...#...#
....#.##..
#.....##.#
#....##..#
......#.#.

Tile 2137:
#.#...#.##
#.......#.
.#.#..#..#
##.....#.#
.....#...#
...#......
#........#
....#....#
.......#..
.#.#.#####

Tile 1451:
...#.#.##.
##.#......
.###...#.#
..##....##
....##....
...#..#...
...#..#.#.
##..#....#
#..#...##.
.###....##

Tile 2927:
.#...#....
.#.......#
#...#....#
##.......#
..#....#.#
#.#....#..
#....#..##
#........#
#.#.......
#########.

Tile 2179:
...#..#..#
#....##...
....#...##
...#.#..##
#........#
..#.#...##
.#........
.###.####.
....#.#..#
..#.#.....

Tile 2267:
#.##...##.
.....#...#
..###...##
.....#..##
.....#...#
##........
#..#..#...
....##....
....#....#
###.####..

Tile 2423:
....###.##
#....#.#..
#......#.#
...#.....#
......#..#
.#......##
#.#......#
..........
...#..##..
##.##...##

Tile 3989:
.#.#....#.
#........#
..##....##
.#.###.##.
.....#....
#...##.##.
#....##..#
#.........
#....#....
.#..###...

Tile 1913:
.####...##
#.........
....#...#.
#.......##
#...#....#
#...#.....
.#.##...#.
.......#..
##..#...#.
.##..#.##.

Tile 2017:
.#.##.###.
#.....#...
..#..#...#
#........#
......#.#.
#...#....#
#.#.#...#.
.###.#....
.##...####
#.##.#####

Tile 1277:
.##...#.##
#..#.....#
#.#.#...##
#.#.#...##
.####....#
....#....#
.....#....
#....####.
#.........
#...#...#.

Tile 1999:
.##.##..#.
#.........
#...#.....
...#......
#.#.....#.
....#....#
........##
#......#.#
..#.#....#
.#.#.#....

Tile 2803:
#......##.
..##.##...
...#.#....
#...#....#
....#.#..#
#...#...##
.........#
#...#.##..
....##.#.#
#..#..#.#.

Tile 1801:
...#.###.#
...#.###..
...##..#.#
....##.###
##.......#
....#.#..#
##.###..#.
...#...#.#
#.##..##..
###......#

Tile 1009:
...#..#.#.
#.##.#....
#.....##..
#.#..#....
#.........
#....#.#.#
#....##..#
..##......
..#.#...#.
##.###.#.#

Tile 3329:
..#.###...
.#....#.#.
..........
#....##..#
##.##..###
..........
..........
#...#.#...
###.#..###
#####.##.#

Tile 3719:
..#.###.#.
#....#...#
##..#.##.#
....#.###.
##.....#.#
##....#...
##.......#
#.#......#
.##...#.#.
####..##.#

Tile 2381:
##.#......
#.....#...
#.....#...
.....##...
..##...##.
###......#
#.....#.##
..#...####
#.#...#..#
#..#......

Tile 2593:
###.#.###.
..#.##..##
#.#......#
....#.####
..#...##.#
..#.#.#...
#.##......
..#..#...#
.##.##...#
.###.##.##

Tile 3559:
...#...#..
#..#.#.#..
..........
.#.#......
..#......#
....#....#
.......###
...#..###.
..#.#...#.
..#.##.##.

Tile 2953:
#.##.....#
.........#
#...#.....
#...#....#
...#....#.
#..#...#..
#.....#.##
#...#.#..#
...###..##
..#..##..#

Tile 1283:
..#..#.#.#
##.....#.#
.........#
#.....#...
###......#
..#.#.####
#..#.....#
..#...#..#
###.##....
...#...###

Tile 2897:
.......###
##.#....#.
#.....####
##...#...#
.....#....
#.....#...
.##...##..
.....#...#
......#..#
.#....##.#

Tile 3779:
###..####.
#..##..#.#
#.#...#..#
......#..#
#....#....
...#...##.
......####
##....#..#
#.#....#..
#####....#

Tile 2693:
#.#.#.####
..........
#.#.#....#
..#.#..#.#
##.....#.#
##....#...
.##.#.....
##.......#
.....#....
.###.#..#.

Tile 1453:
#..##....#
#..#....#.
#.#....##.
.##.#....#
..#.#....#
.###.....#
....##....
#...##...#
#.###.....
.##....#..

Tile 1459:
.##.##.###
..#.......
......##.#
##...#...#
#.#.....##
#.#......#
...##.#...
###..#...#
...#....#.
...##.#.##

Tile 1109:
#.#.#.#..#
#..#.####.
.....##..#
.##...#..#
.#...###.#
........#.
.....#.#.#
...#...###
....#.#..#
##..#..##.

Tile 3943:
...###....
##...###.#
####.....#
#.........
.#......#.
..#..#.#.#
..#....#..
##..#....#
#..#.....#
#.##..#.##

Tile 1129:
###...##..
....#....#
#........#
#......#..
..#...#...
#......#.#
....#...#.
.....#....
##......##
#..####.#.

Tile 2837:
...###.#.#
#......#..
..#.....##
.....#...#
#......#..
..........
#......#..
#.#.....##
#.#.#.....
.####.##..

Tile 3299:
####..#...
#........#
#...#..#.#
#.#....#..
#...#.....
...##.#..#
#.#.....##
..##......
#...#.#..#
#.###..##.

Tile 1493:
#..##..#.#
###......#
..........
...#.....#
....#.....
...#.....#
.#........
...###..#.
.#.#...#.#
####.#.#..

Tile 3931:
#.####....
.....###.#
...#....#.
#.#....#.#
#..#.....#
#........#
...##..#..
.....#....
#..#...#.#
#.###.##..

Tile 2879:
#####.....
##.#.#...#
#.....#.##
##....#.##
#..#......
#.#...#...
..#.....#.
...#...###
...#....##
.#.###.#..

Tile 2617:
##.#.#.#.#
.....#.#..
#...#.....
#...##...#
.#.......#
#.#.......
##..#.....
#......###
..#..#...#
.###..#..#

Tile 2383:
..#.#..#.#
#..#......
#...#.#...
....##...#
.#..#.#..#
#####....#
#.#......#
#........#
..##...###
.##.##.###

Tile 3373:
.##..####.
...#..#.##
#..#.....#
####...#.#
#..#..#...
#.#....##.
##.#....##
.#..##..#.
.##..#...#
######..#.

Tile 3803:
.#..#.##..
.......##.
#....#....
..#......#
...##.....
#.........
..##......
#.#...#..#
..##.....#
#..#####..

Tile 3677:
.#.#####.#
#...#.....
.....#....
..#......#
.#.#...#.#
..###.##..
##...##..#
#..#......
#...#..#..
...#####.#

Tile 3323:
####.#..#.
#..#.##..#
#.........
.#.......#
#.#.....#.
#..#.....#
#....##.#.
.......#.#
#####..#..
.#.##.####

Tile 3457:
.#.#..#..#
.#..#.....
..##..#...
......#..#
.#.....#.#
#.........
#..#..#.#.
#####....#
###.#...#.
#..###.###

Tile 1303:
##..#.####
#.#..#....
.....#...#
#.#.......
#..####...
#...##....
###..#..##
##.......#
#...#..#.#
#..#.#..##

Tile 2687:
.####...##
#..#.....#
..#...#...
##.....#.#
#.....#..#
#.........
...#.#...#
.........#
#..#.....#
#.##.#...#

Tile 1907:
..#....###
....#...##
..#.##..#.
.#....##..
......#...
......#.#.
#.....#.##
..#...#...
....#....#
#####.####

Tile 3217:
#.##.##...
#..#.##...
.#..#.##..
#.....#.#.
....#.....
###.#.##..
.#.#.###..
#.........
#......#.#
#.###..##.

Tile 3923:
#.##.#..##
......#..#
#.....#...
..#.#.....
#........#
.#...#...#
.....#...#
.#..#.##.#
..#..#...#
..#####.##

Tile 2239:
#.#.###.##
#..#..#...
.##..#....
#...##..#.
#........#
..#.#.....
##.##.....
#.#..###.#
##..##....
#.#.#..##.

Tile 1823:
###..###..
.#.##...#.
..###....#
#.#..#...#
###.#.....
#.#...#.##
#...##..##
##.#...#.#
#....#.###
.#.##.#..#

Tile 2711:
.#.#.....#
.....#..##
..#..#..##
#.........
..........
#.##..##.#
####..####
###.......
........#.
.#.#.####.

Tile 1123:
###.#.##.#
........##
.......##.
.#........
.#....#..#
###.#.##..
..##......
#.#.#.....
##...#..##
###..#####

Tile 3659:
...##.##..
.#....#...
.#..#.....
..........
.....#.#..
...#...###
#.....#...
.#........
#..#......
#...#.#..#

Tile 3499:
###..##.#.
#..##....#
###.#.....
#####.....
..#.......
###..#.#..
......##.#
.#.......#
#.##.#...#
.#.#.##.##

Tile 3019:
#..#.###..
....#....#
.#......##
###.#....#
..#.#.....
..##....#.
.#..#..#.#
.........#
....#...##
##..#.#..#

Tile 3529:
####....##
..##...#.#
#.........
...#......
......#..#
##......##
#.##....##
##.#...#.#
#.#.......
###.##..#.

Tile 1733:
##..#....#
....#.....
#.#......#
..#..#...#
...#....#.
.....#....
.......#.#
......#..#
#.#.#..###
.###.#.##.

Tile 1367:
#.#.###.#.
#.##.##.#.
##..#.##..
#.....####
.##...#..#
...##.#..#
#.......##
.##..##..#
#.##......
#...###...

Tile 2557:
##.#######
#..#####..
##.#.#...#
#..#.#....
.#..#....#
###...#..#
##..#.#...
#...##..##
#.#.##.#.#
#.#...#..#

Tile 2081:
.###..#..#
.....#....
##.....#..
..........
..........
#.##......
.........#
......#.#.
...#.....#
...###.#.#

Tile 3391:
.##.#.....
...###...#
..#.##....
#...#.#..#
#......##.
#........#
...#..#..#
.....#....
.#...#....
##....#...

Tile 2657:
#.#.##.#..
##...#....
..#...#...
#.........
.........#
##........
##...#....
##.....#..
...#...#.#
##...###..

Tile 1429:
.###.....#
#........#
..#.#..#..
.......###
.......#..
.......##.
##..#...##
.#......#.
..#....#..
.##.##....

Tile 2339:
.#.####...
#......#..
#.#...##..
##....##.#
......##.#
.#......#.
.#...#..##
#........#
#.##.#.###
..#..#.#..

Tile 2347:
..###..###
..###.....
#..#..##..
#......#..
#.#..#.#.#
......##..
.#..#..#..
..#.....##
#.##..##..
#..###....

Tile 2957:
...#.####.
#.....#...
#..#......
#.....#.#.
..#.#..#.#
....#...##
###.#.##.#
.#...##..#
#........#
#.#.####..

Tile 2477:
.###.##.##
.#.....#..
#......#..
....##.#..
##........
..#....#.#
##...#.###
.#.#..#...
..#..#.#.#
.....#.#.#

Tile 1669:
#.##..#.##
.#......#.
#####..#.#
..##...#.#
#.#..#....
##........
##.#......
##..#....#
##.#..#..#
##...##.##

Tile 2887:
######.#..
#..#..##.#
#..#..#..#
#..###..#.
#........#
.....##..#
.#..##.#..
..........
##..#.#..#
##.#..#..#

Tile 3517:
.#....#.##
#..#.##.#.
..........
##...#..##
#.........
#...#.#..#
#...#..#..
...#......
..........
#......#.#

Tile 3257:
####.....#
.#...##...
#.#.#.#..#
#.##......
##.#..#...
.##.##..#.
#......#.#
..##......
#...#....#
#...##.###

Tile 2029:
#.#.....##
.........#
.#..#.....
...#.....#
...#.###.#
....#.#..#
..........
#..#..#...
#........#
.#####..##

Tile 1777:
###....#..
#..#......
......##..
.....#.#..
##....#..#
#..#...#..
..##....##
##..#..#..
#......#.#
.#.....##.

Tile 3881:
#..###..#.
##.#.##..#
#.........
#...#.#..#
#.........
.#..#.#.##
....#.....
#..###.#..
#..##.#..#
###..#.#.#

Tile 3919:
.##..##..#
..........
......#...
..........
...#.#..##
#........#
......###.
#....#.##.
..#.....##
.##.##....

Tile 1051:
####..###.
.....##...
#.#......#
..#.....#.
#....#...#
##.#..####
......####
#..#.....#
#......#..
##.#####..

Tile 2539:
.#.#.#..##
.#.#.#..##
..##...#.#
...#...#.#
#...#..##.
#...##.##.
.#....#..#
....#...#.
#.##..###.
.##.###...

Tile 2833:
#####.###.
.#...#...#
.........#
..#.#.#..#
####..#..#
#..#......
#.##..#...
#.##....##
#.#..#.##.
##.#.##.#.

Tile 1297:
.#.#.####.
..........
##..#####.
#....##..#
.#.......#
.#.##.....
#.#.#.#..#
...#..#...
#...#.#..#
.#...#####

Tile 1093:
.##..#...#
#.#.#.....
....#...#.
...#....##
....##..#.
#.......##
...#.#...#
#...#.#..#
....#..#.#
####.#.#..

Tile 2843:
.#.#..##..
..#...###.
....#.#..#
###..#.##.
..#....#..
#.........
#...#..#.#
#.#...#..#
##..####..
...#####..

Tile 2243:
...##..#.#
.......#..
#........#
....#....#
.........#
#..#......
..#..#.#.#
.#.#.##...
#...##.#..
....###.##

Tile 1091:
..######.#
.##..#..#.
........##
##..#.#.#.
.....###..
..#...#..#
..#.#.#...
...#.....#
#.#.##.#.#
#.....##.#

Tile 2609:
#.#.#...##
#..#..#..#
...####...
..#.#..#.#
#...##.#..
#.##.#..##
#..##....#
#.#...#.#.
.#...##...
.#.###...#

Tile 3527:
.#....###.
#..#...#.#
........##
#.#..#..#.
.......#.#
........##
#.....#...
##..####..
#..##...#.
.#.#.##..#

Tile 1229:
.#####.##.
...#.#....
#.#.##...#
.#...##..#
#....#...#
#.#..#...#
.#....#...
....#....#
#.#......#
#.#####.##

Tile 2549:
.#####....
#........#
.#.##.....
#.#...#..#
#.#......#
...#..#..#
...#...#..
##...##..#
.#.#......
####.#...#

Tile 2131:
#.#..#.#.#
##..#.....
#.#..##..#
#...#....#
###.......
#..#######
....#.....
#...#....#
...#.#...#
#...#...#.

Tile 1201:
#...#.#.##
.....#....
##..#.#..#
...#..#..#
.....#...#
..##..#.##
#.#.#..#.#
.....#.#.#
###.#.#..#
..#.##...#

Tile 1321:
.#..#...##
#.#...##..
...#.....#
#....##..#
#.........
.#.......#
#.##....#.
.#..##.###
#...#...##
#.########

Tile 2999:
.......#..
.....#....
.##.......
#..#.....#
#...#.....
####.#..#.
.#...###.#
##.....#.#
#.####...#
.##.......

Tile 1621:
####.....#
..#..#..#.
.#...###..
##...##...
#..#......
#..##.#...
...#..#..#
.##...##.#
......#..#
.#..#...#.

Tile 1483:
.#####..#.
.#...#...#
#.#.#..#..
....####..
#..#..####
...##.....
....#.#...
..#..##...
#..##.#...
.###...#.#

Tile 1579:
.#..######
##..#....#
..#......#
#...#..#..
#........#
#.#.#.#..#
#..#.##.##
#....##.##
.#....##..
##...#####

Tile 2251:
.#.###..##
...##....#
........##
..#..#####
#..#..#..#
#......#..
##.##....#
#........#
........##
#.###...#.

Tile 1511:
#..##.##.#
..#.....##
##.......#
##...#...#
#.##.##.##
#......#..
#..#......
#.#...##.#
.#........
..#..##.##

Tile 3613:
##.###..##
....#..##.
##..#.#...
..###.##.#
.#.###....
#.#.##....
.#.#..##..
#.......#.
......###.
.#..###.##

Tile 1663:
#...#...##
......#.#.
###.#.#..#
#..#......
#.....#.#.
..........
#.....##..
..........
...#.#...#
#.##..#...

Tile 1997:
##...#....
.#.#.....#
##.#.#....
.#.#..#...
...#.#....
.##.##.##.
#...####.#
..#.......
#.#...#...
.#..#.....

Tile 2371:
#.###.#...
##...###.#
#....##.##
#......#.#
##..##....
#.#...##.#
##...##..#
.....#...#
.##.......
##.....#.#

Tile 3709:
.#..##.#.#
###.#..#..
##.#..##..
##.....#.#
..........
#......##.
....#...#.
.#...#....
.#......##
.#....####

Tile 2143:
######.#..
##..#...#.
#...#.....
.#.#...#.#
.....#....
........##
#..#......
.#.#.....#
...#....##
....#..##.

Tile 2621:
##.##.##..
....#..#.#
#..###....
#....#....
.........#
##....#...
###..#...#
.##.......
.#....#.##
..#..#####

Tile 3221:
.....#....
.....##.#.
.......#..
#...#.....
#..#.#...#
#.#....#.#
#........#
.......##.
#.#......#
#..#.#..#.

Tile 1447:
.##..####.
#........#
.#......#.
........##
...#..####
.#....#...
###...#..#
.#..#.#..#
#.##.#...#
.##.#####.

Tile 2551:
.#####..#.
......#...
..#.......
.##.##..##
..#..#....
#..#.....#
......#.##
#.....#..#
#...#..##.
..##...#..

Tile 2851:
####.##..#
..........
....##...#
##.......#
...##..#.#
.#......##
.......#..
#..#.#....
.#.....#.#
.#...#..##

Tile 2129:
#.#.####..
.#.....#..
#.........
#..#......
#.#...#...
#......#..
.#....#..#
..#.#..#.#
#..#....##
#.##.###.#

Tile 1753:
#..#...#.#
##.......#
#....##.#.
#.......##
#...#...##
#.##......
...#..##..
...#.....#
###......#
#......#.#

Tile 1471:
####..##.#
#......##.
#..##.#...
.#...#..##
##.#.#.#.#
......#..#
#...#....#
#....#..#.
#..#..##..
.##.#.###.

Tile 1019:
#..####...
.....#....
#.........
..#......#
#.#..#....
.##.#.#...
....#....#
#...##...#
...#......
#..#####.#

Tile 3467:
......####
#....##.##
...##..#.#
#.....##..
#.##.#...#
..##...###
........#.
#......##.
.......##.
####.#.#.#

Tile 1223:
.#.#..##.#
#.........
#.#...#..#
.....#...#
###..#....
#..###...#
.....#..##
#..#..##..
.#.###....
##.##.##.#

Tile 2293:
##..#..##.
......#...
#......#..
..#.......
#..#...###
..#....##.
......####
....###.#.
#..##.##.#
..#...#..#

Tile 2647:
.#.#......
..#..##..#
.....#....
#......##.
#........#
#.#..#...#
#....##..#
##...#....
....#....#
#.#...####

Tile 1931:
.#..##.#.#
##.#.....#
#...#....#
#....#.#.#
.#....##.#
...#..#..#
##..##...#
##........
.#..#....#
...#..###.

Tile 2819:
.##.###.#.
.........#
#...#....#
#...#.##..
.....##.#.
.#..##...#
#....#..#.
#..#.##.##
#..##....#
.......###

Tile 2749:
##..#...#.
#..##....#
###......#
##...#.##.
#.###..##.
.#.##....#
#.......#.
...#...#..
#...#...#.
.#..##...#

Tile 2309:
#......###
##....#..#
#..#...###
#.......##
##........
..#####..#
..##..#..#
..#.......
#......#..
.###..#.##

Tile 2203:
..#..#..#.
.#....##.#
.........#
...#.#....
#.....#...
.......#..
#........#
#....#..##
.....#.#.#
.#.###.###

Tile 1697:
...#.#..#.
#.......#.
.##....#.#
#....#.##.
....#..###
....#..#.#
....#..#.#
##..##..##
.......#..
..#.#.#...

Tile 3413:
#.#.#...##
......#..#
...###....
...###....
....#.#..#
.....##...
.........#
......#...
.....#....
.##....#..

Tile 3169:
..#.#.##..
..........
#.........
##..#..##.
......#..#
#..#.#....
#.#.......
.......##.
..#.##.#..
.#..##.##.

Tile 2153:
#.#.#.#.##
#.....#..#
........##
#....##...
#...#....#
#.#.......
#.####..#.
...#.###.#
..#.#.....
##.##.##.#

Tile 1031:
.######.#.
....##...#
...##...#.
....##..##
.#...##...
.........#
.#...#..#.
......#..#
..##.....#
##....####

Tile 1097:
.#.#.#.###
#..###.#.#
....#.....
...#..#..#
.#....##.#
#..#.#....
....#..##.
##.###.#.#
...#.#..#.
.#.#.##...

Tile 1789:
###...##..
#.........
...#.....#
#....#....
##...#....
...#...#..
....#..#.#
..........
..#.#..#.#
###.#..###

Tile 3701:
#...#.#.##
#.#...#..#
#....#...#
.....#..##
#.....##.#
...#..##.#
#.....#...
#...#.....
#.......#.
#...#.##.#

Tile 3617:
#...##.#..
..##...#..
...##.....
.#.....###
..#.#####.
###.#.#.#.
.#.#.#...#
#....##...
#.....###.
##.#...###

Tile 3727:
####...##.
#..#....##
##.#.##..#
...##.##..
....#.....
##....##..
#....##.##
....##....
##..##....
.#....##.#

Tile 3343:
...##.#...
..#.#.....
.....#..#.
#...##.#..
#.#.#....#
...#......
....##..##
...#######
.#..#....#
.#.###...#

Tile 3313:
...####.##
#.#.#.....
#..##...##
.#.#.##..#
#...#....#
..#..#....
.#..#.....
##.##...##
...#......
.###....##

Tile 1847:
..##.##.##
##...#.#..
##...#....
#.#......#
#....#....
.......##.
##.#.#.#.#
...#..#..#
....#..#..
#..##..##.

Tile 3557:
..#..#####
......#..#
#.....#..#
..#.......
#.......##
###.#....#
.#.....#.#
##........
#...#.....
.##...#.##

Tile 1867:
...##.###.
#......##.
#.#.#...#.
#........#
#.....#...
#....#...#
.#..#.#...
...###....
##.#..#.##
#..#.###..

Tile 2039:
##.#.#####
#.#....#..
.#.#.....#
##.....#..
###..#..##
....#.....
##..##....
.........#
..#.#.#..#
###...#.##

Tile 3301:
..#..##..#
....#...#.
#....###..
.....#..#.
....##...#
#......#..
....#....#
......####
.......###
..#..###.#

Tile 1213:
..#.#..#..
#.#....###
..#......#
##.#......
..#....###
...#.....#
.#.#.....#
#.#.....##
..##.#..#.
...#...#.#

Tile 2437:
#.#####.##
.##...#.##
#..#.#...#
.....#....
.##...#.#.
....##.#..
#...#.....
##.#..#..#
#....#..##
.#.######.

Tile 3511:
.#.###.##.
...#...#..
#...#.##.#
.....#....
.#........
........#.
##.#......
....#.....
....#...#.
.#.##..##.

Tile 2719:
..#.#.###.
#.##...#..
...#..##..
#........#
.........#
.....####.
#.....#.#.
#.#.......
...#...##.
###.##..#."""

# input_ = """Tile 2311:
# ..##.#..#.
# ##..#.....
# #...##..#.
# ####.#...#
# ##.##.###.
# ##...#.###
# .#.#.#..##
# ..#....#..
# ###...#.#.
# ..###..###

# Tile 1951:
# #.##...##.
# #.####...#
# .....#..##
# #...######
# .##.#....#
# .###.#####
# ###.##.##.
# .###....#.
# ..#.#..#.#
# #...##.#..

# Tile 1171:
# ####...##.
# #..##.#..#
# ##.#..#.#.
# .###.####.
# ..###.####
# .##....##.
# .#...####.
# #.##.####.
# ####..#...
# .....##...

# Tile 1427:
# ###.##.#..
# .#..#.##..
# .#.##.#..#
# #.#.#.##.#
# ....#...##
# ...##..##.
# ...#.#####
# .#.####.#.
# ..#..###.#
# ..##.#..#.

# Tile 1489:
# ##.#.#....
# ..##...#..
# .##..##...
# ..#...#...
# #####...#.
# #..#.#.#.#
# ...#.#.#..
# ##.#...##.
# ..##.##.##
# ###.##.#..

# Tile 2473:
# #....####.
# #..#.##...
# #.##..#...
# ######.#.#
# .#...#.#.#
# .#########
# .###.#..#.
# ########.#
# ##...##.#.
# ..###.#.#.

# Tile 2971:
# ..#.#....#
# #...###...
# #.#.###...
# ##.##..#..
# .#####..##
# .#..####.#
# #..#.#..#.
# ..####.###
# ..#.#.###.
# ...#.#.#.#

# Tile 2729:
# ...#.#.#.#
# ####.#....
# ..#.#.....
# ....#..#.#
# .##..##.#.
# .#.####...
# ####.#.#..
# ##.####...
# ##..#.##..
# #.##...##.

# Tile 3079:
# #.#.#####.
# .#..######
# ..#.......
# ######....
# ####.#..#.
# .#...#.##.
# #.#####.##
# ..#.###...
# ..#.......
# ..#.###..."""

# input_ = """Tile 3079:
# #.#.#####.
# .#..######
# ..#.......
# ######....
# ####.#..#.
# .#...#.##.
# #.#####.##
# ..#.###...
# ..#.......
# ..#.###...

# Tile 2473:
# #....####.
# #..#.##...
# #.##..#...
# ######.#.#
# .#...#.#.#
# .#########
# .###.#..#.
# ########.#
# ##...##.#.
# ..###.#.#."""

import re
import random
from collections import Counter
from copy import deepcopy

def solve_1(images):
    def getXEdge(img, edge):
        return {p for p,_ in filter(lambda x : x[1]==edge, img)}

    def getYEdge(img, edge):
        return {p for _,p in filter(lambda x : x[0]==edge, img)}

    def flip(img):
        # Flip over Y
        new_img = []
        for x,y in img:
            new_img.append((X-x-1,y))
        return new_img

    def rotate(img):
        new_img = []
        for x,y in img:
            new_img.append((Y-y-1,x))
        return new_img

    def isAdjecent(rimg, rv, img):

        def isAdjecent_(img_):
            def testAndAppend(img__):

                x_y0   = getXEdge(img__, 0)
                x_yMax = getXEdge(img__, Y-1)
                y_x0   = getYEdge(img__, 0)
                y_xMax = getYEdge(img__, X-1)

                adjecents__ = []
                if getXEdge(rimg, Y-1) == x_y0:
                    adjecents__.append(((rv[0],rv[1]+1),img__))
                if getXEdge(rimg, 0) == x_yMax:
                    adjecents__.append(((rv[0],rv[1]-1),img__))
                if getYEdge(rimg, X-1) == y_x0:
                    adjecents__.append(((rv[0]+1,rv[1]),img__))
                if getYEdge(rimg, 0) == y_xMax:
                    adjecents__.append(((rv[0]-1,rv[1]),img__))
                return adjecents__

            adjecents_ = testAndAppend(img_)
            adjecents_.extend(testAndAppend(flip(img_)))
            return adjecents_

        adjecents = []
        rotated = img.copy()
        for _ in range(4):
            adjecents.extend(isAdjecent_(rotated))
            rotated = rotate(rotated)

        return adjecents

    def fitsToReassembled(new_segment, reassembled):
        ik,((x,y),img) = new_segment
        neighbours = [(x-1,y), (x,y-1), (x+1,y), (x,y+1)]
        for n in neighbours:
            for rk,(rpos,rimg) in reassembled.items():
                if n==rpos :
                    positions = []
                    for a,_ in isAdjecent(rimg, rpos, img):
                        positions.append(a)
                    if not (x,y) in positions:
                        return False
        return True

    def getMinsAndMaxs(reassembled):
        x_values = sorted(list(reassembled.items()),key=lambda item: item[1][0][0])
        y_values = sorted(list(reassembled.items()),key=lambda item: item[1][0][1])
        min_x = x_values[0][1][0][0]
        min_y = y_values[0][1][0][1]
        max_x = x_values[-1][1][0][0]
        max_y = y_values[-1][1][0][1]
        return min_x,min_y,max_x,max_y

    def isCorrectSize(reassembled):
        min_x,min_y,max_x,max_y = getMinsAndMaxs(reassembled)

        if (max_x - min_x) > EXPECTED_SIZE or (max_y - min_y) > EXPECTED_SIZE:
            return False
        return True

    def printImage(img):
        for y in range(Y):
            for x in range(X):
                if (x,y) in img:
                    print('#',end='')
                else:
                    print('.',end='')
            print('')

    def printPicture(reassembled):
        min_x,min_y,max_x,max_y = getMinsAndMaxs(reassembled)
        border = 1

        picture = [[ '.' for x in range((max_x-min_x+1)*(X-2*border))] for y in range((max_y-min_y+1)*(Y-2*border))]

        for j,row in enumerate(picture):
            ry = j//(Y-2*border) + min_y
            iy = j%(Y-2*border) + border
            for i,_ in enumerate(row):
                rx = i//(X-2*border) + min_x
                ix = i%(X-2*border) + border
                for rk,((x,y),img) in reassembled.items():
                    if rx == x and ry == y and (ix,iy) in img:
                        picture[j][i] = '#'

        # Flip to show exactly the example image
        new_pic = deepcopy(picture)
        n = len(picture)
        for i,row in enumerate(picture):
            for j,_ in enumerate(row):
                new_pic[i][j] = picture[n-i-1][j]
        picture = deepcopy(new_pic)

        for y in picture:
            for x in y:
                print(x, end='')
            print('')
        print('')

    def solve(leftovers_, reassembled_):
        print(len(leftovers_), len(reassembled_), len(leftovers_)+len(reassembled_), flush=True)
        leftovers = leftovers_.copy()
        reassembled = reassembled_.copy()

        if len(leftovers) == 0:
            if not isCorrectSize(reassembled):
                return None
            printPicture(reassembled)

            min_x,min_y,max_x,max_y = getMinsAndMaxs(reassembled)

            solution = 1
            for k,((x,y),rimg) in reassembled.items():
                if (x == min_x and y == min_y) or \
                   (x == min_x and y == max_y) or \
                   (x == max_x and y == min_y) or \
                   (x == max_x and y == max_y) :
                    solution *= k
            return solution

        possibles = []
        for ik,img in leftovers.items():
            for rk,((x,y),rimg) in reassembled.items():
                adjecents = isAdjecent(rimg,(x,y),img)
                if adjecents:
                    for adj in adjecents:
                        new_possible = (ik,adj)
                        if not adj in list(reassembled.values()) and \
                            not new_possible in possibles and \
                            fitsToReassembled(new_possible, reassembled) :
                            possibles.append(new_possible)

        reassembleds = []
        for k,v in possibles:
            new_reassembled = {**reassembled, **{k:v}}
            if not isCorrectSize(new_reassembled):
                continue
            # printPicture(reassembled)

            if solution := solve({x: leftovers[x] for x in leftovers.keys() - {k}},
                                 new_reassembled):
                return solution
        return None

    EXPECTED_SIZE = len(images)**(1/2) - 1
    X = max([x for _,v in images.items() for x,_ in v]) + 1
    Y = max([y for _,v in images.items() for _,y in v]) + 1

    key = next(iter(images))
    value = images[key]
    reassembled_start = dict([(key,((0,0),value))])
    solution = solve({x: images[x] for x in images.keys() - {key}}, reassembled_start)

    return solution

images = input_.split('\n\n')
k = list(map(lambda x : int(re.match('Tile (\d+):',x).group(1)), images))
v = list(map(lambda x : x.split(':\n')[1], images))
v = [[[z=='#' for z in x ] for x in y.splitlines()] for y in v]

### TODO: save this parser to Utils
all_parsed = []
for image in v:
    parsed = []
    for i,y in enumerate(image):
        for j,x in enumerate(y):
            if x:
                parsed.append((j,i))
    all_parsed.append(parsed)
d = dict(zip(k, all_parsed))

print("Part #1: ", solve_1(d))


